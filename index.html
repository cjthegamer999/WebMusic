<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>WebMusic</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

<style>
body{margin:0;font-family:sans-serif;background:#121212;color:white}
header{padding:12px 20px;background:#000;display:flex;justify-content:space-between;align-items:center}
button{cursor:pointer}
.section{padding:20px}
.song{padding:10px;border-bottom:1px solid #333;cursor:pointer}
.song:hover{background:#1e1e1e}
.hidden{display:none}
.modal{position:fixed;inset:0;background:rgba(0,0,0,.8);display:flex;align-items:center;justify-content:center;z-index:999}
.modal-box{background:#181818;padding:20px;width:300px;text-align:center}
input{width:100%;margin-bottom:10px;padding:8px}
.warning{background:#331;padding:15px;margin-bottom:15px}
.admin{color:#1db954;font-weight:bold}
</style>
</head>

<body>

<header>
  <div><b>WebMusic</b></div>
  <div id="userBtn">Log in</div>
</header>

<div class="section">
  <button id="uploadBtn">Upload MP3</button>
  <button id="unapprovedBtn">Unapproved Audio ‚ö†Ô∏è</button>
</div>

<div class="section">
  <h2>Approved Music</h2>
  <div id="approvedList"></div>
</div>

<div class="section hidden" id="unapprovedSection">
  <div class="warning">
    ‚ö†Ô∏è This section contains unmoderated user uploads.  
    Content may be explicit or copyrighted.
  </div>
  <h2>Unapproved Audio</h2>
  <div id="unapprovedList"></div>
</div>

<audio id="player" controls style="width:100%;position:fixed;bottom:0;"></audio>

<!-- AUTH MODAL -->
<div id="authModal" class="modal hidden">
  <div class="modal-box">
    <h3>Log in</h3>
    <input id="email" placeholder="Email">
    <input id="password" type="password" placeholder="Password">
    <button onclick="emailLogin()">Email Login</button><br><br>
    <button onclick="googleLogin()">Google Login</button><br><br>
    <button onclick="closeAuth()">Cancel</button>
  </div>
</div>

<!-- UPLOAD MODAL -->
<div id="uploadModal" class="modal hidden">
  <div class="modal-box">
    <h3>Upload MP3</h3>
    <input id="songTitle" placeholder="Song title">
    <input type="file" id="fileInput" accept="audio/mpeg">
    <button onclick="uploadSong()">Upload</button><br><br>
    <button onclick="closeUpload()">Cancel</button>
  </div>
</div>

<script>
/* üî¥ FIREBASE CONFIG ‚Äî REPLACE WITH YOUR OWN */
firebase.initializeApp({
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_PROJECT.firebaseapp.com",
  projectId: "YOUR_PROJECT",
  storageBucket: "YOUR_PROJECT.appspot.com",
});

/* Firebase refs */
const auth = firebase.auth();
const db = firebase.firestore();
const storage = firebase.storage();

let currentUser = null;
let isAdmin = false;

/* AUTH */
auth.onAuthStateChanged(async user => {
  currentUser = user;
  isAdmin = false;

  if (user) {
    userBtn.textContent = user.email;
    const role = await db.collection("roles").doc(user.uid).get();
    if (role.exists && role.data().admin) {
      isAdmin = true;
      userBtn.innerHTML += ' <span class="admin">(admin)</span>';
    }
  } else {
    userBtn.textContent = "Log in";
  }
});

/* AUTH UI */
userBtn.onclick = () => currentUser ? auth.signOut() : authModal.classList.remove("hidden");
function closeAuth(){authModal.classList.add("hidden");}
function emailLogin(){
  auth.signInWithEmailAndPassword(email.value,password.value).catch(e=>alert(e.message));
}
function googleLogin(){
  auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()).catch(e=>alert(e.message));
}

/* UPLOAD */
uploadBtn.onclick = () => {
  if (!currentUser) return authModal.classList.remove("hidden");
  uploadModal.classList.remove("hidden");
};
function closeUpload(){uploadModal.classList.add("hidden");}

async function uploadSong(){
  const file = fileInput.files[0];
  if (!file || file.type !== "audio/mpeg") return alert("MP3 only");

  const ref = storage.ref("songs/" + Date.now() + "_" + file.name);
  await ref.put(file);
  const url = await ref.getDownloadURL();

  await db.collection("songs").add({
    title: songTitle.value,
    url,
    approved: false,
    uploader: currentUser.uid,
    created: firebase.firestore.FieldValue.serverTimestamp()
  });

  closeUpload();
  loadSongs();
}

/* LOAD SONGS */
async function loadSongs(){
  approvedList.innerHTML = "";
  unapprovedList.innerHTML = "";

  const snap = await db.collection("songs").orderBy("created","desc").get();
  snap.forEach(doc=>{
    const s = doc.data();
    const div = document.createElement("div");
    div.className = "song";
    div.textContent = s.title;
    div.onclick = ()=>player.src=s.url;

    if (s.approved) {
      approvedList.appendChild(div);
    } else {
      if (isAdmin) {
        const approve = document.createElement("button");
        approve.textContent = "Approve";
        approve.onclick = ()=>doc.ref.update({approved:true});
        div.appendChild(approve);
      }
      unapprovedList.appendChild(div);
    }
  });
}

unapprovedBtn.onclick = ()=>{
  if (confirm("This section contains unmoderated content. Continue?")) {
    unapprovedSection.classList.toggle("hidden");
  }
};

loadSongs();
</script>

</body>
</html>
