<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>WebMusic</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

<style>
:root{
--bg:#000;--panel:#121212;--panel2:#181818;--panel3:#282828;
--text:#fff;--muted:#b3b3b3;--green:#1db954
}
*{box-sizing:border-box}
body{
margin:0;height:100vh;
display:grid;
grid-template-columns:240px 1fr;
grid-template-rows:1fr 90px;
background:var(--bg);color:var(--text);
font-family:Arial,Helvetica,sans-serif
}
aside{padding:24px;background:#000}
.nav{color:var(--muted);font-weight:bold;margin:12px 0;cursor:pointer}
.nav.disabled{opacity:.4;pointer-events:none}
.nav:hover{color:white}
main{padding:24px;overflow:auto;background:linear-gradient(#1f1f1f,#121212)}
.topbar{display:flex;justify-content:space-between;align-items:center}
#userBtn{cursor:pointer;padding:6px 12px;border-radius:20px;border:1px solid var(--panel3)}
.logged{border-color:var(--green);color:var(--green)}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:24px;margin-top:20px}
.card{background:var(--panel2);padding:16px;border-radius:8px;cursor:pointer;position:relative}
footer{grid-column:1/3;background:#181818;border-top:1px solid #282828;padding:10px}
audio{width:100%}
.hidden{display:none}
.profile{display:flex;align-items:center;gap:12px;margin-top:12px}
.profile img{width:64px;height:64px;border-radius:50%;object-fit:cover}
.admin{color:#ff4d4d;font-weight:bold;margin-top:6px}
.section{
margin-top:24px;
padding-top:16px;
border-top:1px solid var(--panel3)
}
input{
width:100%;
padding:10px;
margin:6px 0;
background:#000;
border:1px solid var(--panel3);
color:white;
border-radius:6px
}
button{
width:100%;
padding:10px;
margin-top:8px;
border:none;
border-radius:20px;
background:var(--green);
font-weight:bold;
cursor:pointer
}
.secondary{
background:transparent;
border:1px solid var(--panel3);
color:white
}
</style>
</head>

<body>

<aside>
<h2>ðŸŸ¢ WebMusic</h2>
<div class="nav" id="homeBtn">Home</div>
<div class="nav" id="accountBtn">Account</div>
<div class="nav disabled" id="uploadBtn">Upload (login)</div>
</aside>

<main>
<div class="topbar">
<h2 id="pageTitle">Home</h2>
<div id="userBtn">Log in</div>
</div>

<div id="homePage">
<div class="grid" id="songList"></div>
</div>

<div id="accountPage" class="hidden">
<h3>Account</h3>

<div class="profile">
<img id="profilePic">
<div>
<div id="profileName"></div>
<div id="profileEmail" style="color:var(--muted)"></div>
<div id="adminBadge" class="admin hidden">ADMIN</div>
</div>
</div>

<div class="section">
<h4>Link Email & Password</h4>
<p style="color:var(--muted);font-size:14px">
This lets you log in without Google.
</p>
<input id="linkEmail" placeholder="Email">
<input id="linkPassword" type="password" placeholder="Password">
<button onclick="linkEmailPassword()">Add Email Login</button>
</div>

</div>
</main>

<footer>
<audio id="player" controls></audio>
</footer>

<script>
firebase.initializeApp({
apiKey:"AIzaSyDXmhJB-AJlK6z8OZBY-6gfFU6jOzbHc7s",
authDomain:"webmusic-eb2fb.firebaseapp.com",
projectId:"webmusic-eb2fb",
storageBucket:"webmusic-eb2fb.firebasestorage.app",
messagingSenderId:"982822581676",
appId:"1:982822581676:web:20b402e0ea4571f510f609"
});

const auth=firebase.auth();
const db=firebase.firestore();
const provider=new firebase.auth.GoogleAuthProvider();

let user=null;
let isAdmin=false;

/* AUTH STATE */
auth.onAuthStateChanged(async u=>{
user=u;
if(!u){
userBtn.textContent="Log in";
uploadBtn.classList.add("disabled");
return;
}

const role=await db.collection("roles").doc(u.uid).get();
isAdmin=role.exists && role.data().admin===true;

const userDoc=await db.collection("users").doc(u.uid).get();
const photo=userDoc.exists && userDoc.data().photo ? userDoc.data().photo : u.photoURL;

userBtn.innerHTML=`<img src="${photo}" style="width:32px;height:32px;border-radius:50%">`;
uploadBtn.classList.remove("disabled");

profilePic.src=photo;
profileName.textContent=u.displayName;
profileEmail.textContent=u.email;
adminBadge.classList.toggle("hidden",!isAdmin);
});

/* LOGIN */
function googleLogin(){
auth.signInWithPopup(provider);
}
userBtn.onclick=()=>user?auth.signOut():googleLogin();

/* NAV */
homeBtn.onclick=()=>{
homePage.classList.remove("hidden");
accountPage.classList.add("hidden");
pageTitle.textContent="Home";
}
accountBtn.onclick=()=>{
if(!user)return alert("Log in first");
homePage.classList.add("hidden");
accountPage.classList.remove("hidden");
pageTitle.textContent="Account";
}

/* LINK EMAIL */
function linkEmailPassword(){
if(!user) return alert("Not logged in");

const email=linkEmail.value;
const password=linkPassword.value;
if(!email||!password) return alert("Fill in both fields");

const cred=firebase.auth.EmailAuthProvider.credential(email,password);

user.linkWithCredential(cred)
.then(()=>{
alert("Email/password linked successfully");
profileEmail.textContent=email;
})
.catch(err=>{
alert(err.message);
});
}

/* UPLOAD */
uploadBtn.onclick=()=>{
if(!user)return alert("Log in first");
uploadModal.classList.remove("hidden");
}
function closeUpload(){uploadModal.classList.add("hidden")}

async function uploadSong(){
const f=fileInput.files[0];
if(!f)return alert("Select MP3");
const ref=storage.ref("songs/"+Date.now()+"_"+f.name);
await ref.put(f);
const url=await ref.getDownloadURL();
await db.collection("songs").add({url,created:Date.now()});
uploadModal.classList.add("hidden");
loadSongs();
}

/* SONGS */
async function loadSongs(){
songList.innerHTML="";
const snap=await db.collection("songs").orderBy("created","desc").get();
snap.forEach(d=>{
const c=document.createElement("div");
c.className="card";
c.innerHTML=`<h4>Song</h4><div class="play">â–¶</div>`;
c.onclick=()=>player.src=d.data().url;
songList.appendChild(c);
});
}
loadSongs();
</script>

</body>
</html>
